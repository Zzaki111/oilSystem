# 系统使用指南

## 目录
1. [系统概述](#系统概述)
2. [安装配置](#安装配置)
3. [数据准备](#数据准备)
4. [业务流程](#业务流程)
5. [API接口说明](#api接口说明)
6. [常见问题](#常见问题)

---

## 系统概述

本系统是一个**上市储量价值评估石油生产数据预处理系统**，用于处理和分析石油生产数据，包括：

- **A2数据表**：油田单井的单月生产数据
- **SEC数据表**：包含SEC归属关系的评估数据
- **评估数据表**：用于绘制评估曲线的连续数据

### 主要功能模块

1. **第一业务界面**：对比上年度A2表与SEC表，生成油井单元属性表
2. **第二业务界面**：对比本年度与上年度A2表，识别注销井、新投井、归属变化井
3. **第三业务界面**：生成本年度SEC数据表
4. **第四业务界面**：生成常规油和页岩油评估数据表

---

## 安装配置

### 1. 环境要求

- Python 3.8+
- 推荐使用虚拟环境

### 2. 安装依赖

```bash
cd /Users/zzaki/workspace_oil/oilSystem
pip install -r requirements.txt
```

### 3. 目录结构

```
oilSystem/
├── backend/               # 后端代码
│   ├── models/           # 数据模型
│   ├── services/         # 业务逻辑
│   ├── utils/            # 工具函数
│   └── app.py            # Flask应用
├── frontend/             # 前端代码
│   ├── static/           # 静态资源
│   ├── templates/        # HTML模板
│   └── js/               # JavaScript
├── data/                 # 数据目录
│   ├── input/            # 输入数据
│   └── output/           # 输出数据
└── example_usage.py      # 使用示例
```

---

## 数据准备

### A2数据表格式

A2数据表必须包含以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| 井号 | 字符串 | 唯一标识 |
| 大油田 | 字符串 | 一级归属 |
| 单元 | 字符串 | 二级归属 |
| 年月 | 整数 | 6位数字，如202309 |
| 月产油量(t) | 浮点数 | 月产油量 |
| 月产水量(m3) | 浮点数 | 月产水量 |
| 月产气量(10^4m3) | 浮点数 | 月产气量 |

### SEC数据表格式

SEC数据表必须包含以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| 井号 | 字符串 | 唯一标识 |
| SEC油田 | 字符串 | SEC归属油田 |
| SEC单元 | 字符串 | SEC归属单元 |
| 是否参评 | 字符串 | "是"或"否" |
| 页岩油/常规 | 字符串 | "页岩油"或"常规" |

### 文件命名规范

- A2表：`a2-YYYYMM.xlsx`，如 `a2-202309.xlsx`
- SEC表：`SEC数据表-YYYYMM.xlsx`，如 `SEC数据表-202309.xlsx`
- 评估表：`评估数据表-YYYYMM.xlsx`

---

## 业务流程

### 流程图

```
┌─────────────────┐
│ 上传A2/SEC数据  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  第一业务界面   │ → 生成油井单元属性表
│ (A2与SEC对比)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  第二业务界面   │ → 识别井变化
│ (年度A2对比)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  第三业务界面   │ → 生成本年度SEC表
│ (生成SEC表)     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  第四业务界面   │ → 生成评估数据表
│ (生成评估表)    │
└─────────────────┘
```

### 详细步骤

#### 第一步：对比A2表与SEC表

1. 上传上年度A2数据表（如202409）
2. 上传上年度SEC数据表（如202409）
3. 点击"开始对比"
4. 系统生成：
   - 油井单元属性表
   - A2单元与SEC单元映射关系
   - 三级树形结构图

#### 第二步：识别井变化

1. 上传上年度A2数据表（如202409）
2. 上传本年度A2数据表（如202509）
3. 点击"开始对比"
4. 系统识别：
   - 注销停产井
   - 新投产井
   - 单元归属变化井

#### 第三步：生成本年度SEC表

1. 上传上年度SEC数据表
2. 上传单元变化表（可选）
3. 上传老区新井表（可选）
4. 上传扩边/PUD转PDP/PDNP表（可选）
5. 输入年份和年月
6. 点击"生成SEC数据表"

#### 第四步：生成评估数据表

1. 选择评估类型（常规油/页岩油）
2. 上传相关数据表
3. 点击"生成评估数据表"

---

## API接口说明

### 基础URL
```
http://localhost:5000/api
```

### 1. 上传文件
```
POST /api/upload
Content-Type: multipart/form-data

参数：
- file: 文件对象
- type: 文件类型 (a2/sec/evaluation)

返回：
{
  "success": true,
  "message": "文件上传成功",
  "cache_key": "a2_filename.xlsx",
  "rows": 1000,
  "columns": ["井号", "大油田", ...]
}
```

### 2. 第一业务界面：对比A2与SEC
```
POST /api/business1/compare
Content-Type: application/json

请求体：
{
  "a2_key": "a2_202409.xlsx",
  "sec_key": "sec_202409.xlsx",
  "year_month": 202409
}

返回：
{
  "success": true,
  "message": "对比完成",
  "output_file": "202409_油井单元属性表_20250110_120000.xlsx",
  "statistics": {
    "total": 1000,
    "evaluated": 800,
    "not_evaluated": 200
  }
}
```

### 3. 第二业务界面：对比年度A2
```
POST /api/business2/compare
Content-Type: application/json

请求体：
{
  "last_year_key": "a2_202409.xlsx",
  "this_year_key": "a2_202509.xlsx",
  "year": 2025
}

返回：
{
  "success": true,
  "statistics": {
    "cancelled": 50,
    "new": 80,
    "unit_changed": 30
  }
}
```

### 4. 第三业务界面：生成SEC表
```
POST /api/business3/generate
Content-Type: application/json

请求体：
{
  "last_year_sec_key": "sec_202409.xlsx",
  "unit_change_key": "unit_change.xlsx",
  "old_area_wells_key": "old_area_wells.xlsx",
  "pud_pdp_pdnp_key": "pud_pdp_pdnp.xlsx",
  "this_year": 2025,
  "this_year_month": 202509
}
```

### 5. 下载文件
```
GET /api/download/<filename>
```

---

## 常见问题

### 1. 文件上传失败

**问题**：提示"文件上传失败"

**解决**：
- 检查文件格式是否为 `.xlsx` 或 `.xls`
- 确认文件包含必需字段
- 检查文件大小是否超过限制

### 2. 井号类型不匹配

**问题**：对比时提示找不到井号

**解决**：
- 确保井号格式一致（建议使用字符串）
- 检查是否有前后空格
- 统一井号命名规范

### 3. SEC归属为空

**问题**：提示"SEC油田或SEC单元为空"

**解决**：
- 检查扩边/PUD转PDP/PDNP表中是否填写了SEC归属
- 手工维护缺失的SEC归属信息

### 4. 数据量大导致处理慢

**问题**：处理12个月数据时响应缓慢

**解决**：
- 系统已优化批量数据处理
- 建议单次处理不超过120万条记录
- 可以分批处理后合并结果

### 5. 树形结构显示不全

**问题**：树形图节点无法展开

**解决**：
- 点击节点前的▶符号展开
- 刷新页面重新加载
- 检查浏览器控制台是否有错误

---

## 技术支持

如有问题，请联系技术支持团队。

### 系统版本
- 版本号：1.0.0
- 更新日期：2025-01-10

### 日志文件
系统日志保存在：`logs/` 目录（如果配置了日志）

---

## 附录

### 示例数据生成

运行以下命令生成示例数据：

```bash
python example_usage.py
```

这将在 `data/input/` 目录下生成示例文件：
- `a2-202409_sample.xlsx`
- `SEC数据表-202409_sample.xlsx`

### 批量处理脚本

详见 `example_usage.py` 文件中的示例代码。
