# 石油生产数据预处理系统 - 项目说明

## 📁 项目结构

```
oilSystem/
├── backend/                    # 后端代码
│   ├── app.py                 # Flask应用主入口
│   ├── models/                # 数据模型
│   │   └── data_models.py     # A2、SEC、评估数据模型
│   ├── services/              # 业务逻辑
│   │   ├── business_service_1.py  # 对比A2与SEC表
│   │   ├── business_service_2.py  # 对比年度A2表
│   │   ├── business_service_3.py  # 生成SEC数据表
│   │   └── business_service_4.py  # 生成评估数据表
│   └── utils/                 # 工具类
│       └── data_import_export.py  # 数据导入导出
├── frontend/                  # 前端代码
│   ├── templates/            # HTML模板
│   │   └── index.html        # Web主界面
│   ├── static/               # 静态资源
│   │   ├── css/
│   │   └── js/
├── data/                     # 数据目录
│   ├── input/               # 输入数据
│   └── output/              # 输出结果
├── start.sh                 # 快速启动脚本
├── 前端使用说明.md           # Web界面使用说明
└── 项目说明.md              # 本文件
```

## 🌟 核心功能

### 1. 第一业务界面：对比A2表与SEC表
- **输入：** 上年度A2数据表、上年度SEC数据表
- **处理：** 识别参评井和非参评井
- **输出：** 油井单元属性表、统计信息

### 2. 第二业务界面：对比年度A2表
- **输入：** 上年度A2表、本年度A2表
- **处理：** 识别注销井、新投井、单元变化井
- **输出：** 三种类型井的明细表

### 3. 第三业务界面：生成SEC数据表
- **输入：** 上年度SEC表、单元变化表、老区新井表等
- **处理：** 根据变化信息更新SEC表
- **输出：** 本年度SEC数据表

### 4. 第四业务界面：生成评估数据表
- **输入：** 历史评估数据、A2表等
- **处理：** 按常规油或页岩油生成评估数据
- **输出：** 评估数据表（按单元或按井）

## 🚀 快速开始

### 方法1：使用启动脚本（推荐）

```bash
cd /Users/zzaki/workspace_oil/oilSystem
./start.sh
```

### 方法2：手动启动

```bash
cd /Users/zzaki/workspace_oil/oilSystem/backend
python app.py
```

然后在浏览器访问：**http://localhost:5001**

## 🛠️ 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.8+ | 后端开发语言 |
| Flask | 2.3+ | Web框架 |
| Pandas | 2.0+ | 数据处理 |
| openpyxl | 最新 | Excel文件读写 |
| Flask-CORS | 最新 | 跨域支持 |
| HTML/CSS/JS | - | 前端界面 |

## 📊 数据流程

```
1. 用户上传Excel文件
   ↓
2. 后端接收并缓存文件
   ↓
3. 调用业务服务处理数据
   ↓
4. 使用Pandas进行数据分析
   ↓
5. 生成结果Excel文件
   ↓
6. 返回统计信息和下载链接
   ↓
7. 用户查看结果并下载
```

## 🎨 Web界面特色

### 视觉设计
- 🎨 现代渐变色设计
- 📱 响应式布局
- 🃏 卡片式组件
- ✨ 流畅的动画效果

### 用户体验
- 📤 拖拽上传文件
- ⏳ 实时进度显示
- 💬 智能提示信息
- 📊 数据可视化展示
- 🔽 一键下载结果

### 交互设计
- 四个业务模块，清晰分区
- 侧边导航栏，快速切换
- 表单验证，防止错误输入
- 加载动画，提升体验
- 成功/错误提示，及时反馈

## 🔌 API接口

### 1. 文件上传
```
POST /api/upload
Content-Type: multipart/form-data

参数:
- file: 文件对象
- type: 文件类型 (a2/sec/evaluation)

返回:
{
  "success": true,
  "cache_key": "文件缓存key",
  "message": "上传成功"
}
```

### 2. 业务1 - 对比A2与SEC表
```
POST /api/business1/compare
Content-Type: application/json

{
  "a2_key": "A2文件缓存key",
  "sec_key": "SEC文件缓存key",
  "year_month": 202409
}

返回:
{
  "success": true,
  "statistics": {
    "total": 100,
    "evaluated": 80,
    "not_evaluated": 20
  },
  "output_file": "结果文件名"
}
```

### 3. 业务2 - 对比年度A2表
```
POST /api/business2/compare
Content-Type: application/json

{
  "last_year_key": "上年度A2缓存key",
  "this_year_key": "本年度A2缓存key",
  "year": 2025
}

返回:
{
  "success": true,
  "statistics": {
    "cancelled": 10,
    "new": 15,
    "unit_changed": 5
  },
  "output_files": {
    "cancelled": "注销井文件名",
    "new_wells": "新投井文件名",
    "unit_changed": "单元变化井文件名"
  }
}
```

### 4. 文件下载
```
GET /api/download/<filename>

返回: Excel文件流
```

更多API详情请查看代码注释。

## 📋 数据表结构

### A2数据表（生产数据）
| 字段 | 类型 | 说明 |
|------|------|------|
| 井号 | 文本 | 油井唯一标识 |
| 大油田 | 文本 | 油田名称 |
| 单元 | 文本 | 所属单元 |
| 年月 | 整数 | YYYYMM格式 |
| 投产日期 | 文本 | YYYY-MM-DD |
| 生产天数 | 浮点 | 当月生产天数 |
| 月产液量 | 浮点 | 吨 |
| 月产油量 | 浮点 | 吨 |

### SEC数据表（储量数据）
| 字段 | 类型 | 说明 |
|------|------|------|
| 井号 | 文本 | 油井唯一标识 |
| 评估油田 | 文本 | 评估用油田名 |
| 评估单元 | 文本 | 评估用单元名 |
| 投产年月 | 整数 | YYYYMM格式 |
| 地质储量 | 浮点 | 万吨 |

### 评估数据表
| 字段 | 类型 | 说明 |
|------|------|------|
| 单元/井号 | 文本 | 标识 |
| 年月 | 整数 | YYYYMM格式 |
| 月产油量 | 浮点 | 吨 |
| 累计产油量 | 浮点 | 吨 |

## 🔍 业务逻辑说明

### 业务1：对比A2表与SEC表

**目的：** 识别哪些井参与了储量评估

**逻辑：**
1. 加载A2表和SEC表
2. 过滤指定年月的A2数据
3. 按井号匹配两表数据
4. 在SEC表中的井标记为"参评井"
5. 不在SEC表中的井标记为"非参评井"
6. 生成油井单元属性表

**应用场景：** 年度储量评估准备工作

---

### 业务2：对比年度A2表

**目的：** 识别井的变化情况

**逻辑：**
1. 加载上年度和本年度A2表
2. 提取两表中的井号集合
3. 注销井 = 上年度有 ∩ 本年度没有
4. 新投井 = 本年度有 ∩ 上年度没有
5. 单元变化井 = 两年度都有但单元不同

**应用场景：** 年度井变化分析

---

### 业务3：生成SEC数据表

**目的：** 更新SEC储量表

**逻辑：**
1. 以上年度SEC表为基础
2. 处理单元变化井（更新单元归属）
3. 添加老区新井数据
4. 处理扩边井和PUD转PDP/PDNP井
5. 生成本年度SEC表

**应用场景：** 年度储量表更新

---

### 业务4：生成评估数据表

**目的：** 生成连续月份的评估数据

**常规油逻辑：**
1. 按SEC单元汇总月度数据
2. 生成连续月份记录
3. 调整历史数据（如有变化）
4. 添加本年度新数据

**页岩油逻辑：**
1. 按单井生成月度数据
2. 包含单井投产后的每月记录
3. 更新本年度数据

**应用场景：** 储量评估数据准备

## ⚠️ 注意事项

### 数据质量
- 确保Excel文件格式正确
- 字段名称必须与要求一致
- 数据类型要符合规范
- 避免空值和异常值

### 性能优化
- 大文件处理需要时间
- 建议文件大小控制在50MB以内
- 可分批处理超大数据集

### 错误处理
- 系统会验证输入格式
- 处理失败会显示错误信息
- 可查看后端日志排查问题

### 数据安全
- 上传文件临时存储
- 定期清理缓存文件
- 不要上传敏感数据到公共环境

## 🔧 开发说明

### 添加新功能
1. 在 `backend/services/` 添加业务逻辑
2. 在 `backend/app.py` 添加API路由
3. 在 `frontend/templates/index.html` 添加界面
4. 在前端JS中添加交互逻辑

### 调试技巧
- 使用浏览器开发者工具查看网络请求
- 查看Flask终端输出的日志
- 使用Python调试器断点调试
- 检查生成的Excel文件内容

### 代码规范
- 遵循PEP 8 Python代码规范
- 使用有意义的变量名
- 添加必要的注释
- 编写文档字符串

## 📞 技术支持

如有问题或建议，请：
- 查看使用文档
- 检查代码注释
- 查看错误日志
- 联系系统管理员

## 📄 许可证

本项目仅供内部使用。

---

**版本：** v1.0  
**更新日期：** 2026-01-10  
**作者：** AI Assistant  
**维护：** 项目团队
